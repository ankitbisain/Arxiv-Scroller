<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="manifest" href="appfiles/manifest.json">
    <link rel="stylesheet" href="appfiles/style.css">
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('appfiles/sw.js');
      });
    }
</script>
<meta charset="UTF-8">
<title>Arxiv Scroller</title>


<body>

<div id="selection">
</div>

<script>
fetch('subjects.json')
  .then(r => r.json())
  .then(subjects => {
    const selection = document.getElementById('selection');
    for (const [name, codes] of Object.entries(subjects)) {
      const btn = document.createElement('button');
      btn.dataset.col = `${name}-papers`;
      btn.textContent = name;
      selection.appendChild(btn);
    }
  });
</script>

<div id="card" style="display:none">
    <button id="back-button">â€¹</button>
    <div id="card-content-wrapper"></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const app = initializeApp({
  apiKey: "AIzaSyCfHGY9hreV--enSLSl1_KAhpGAX_1EYAs",
  authDomain: "arxiv-scroller.firebaseapp.com",
  projectId: "arxiv-scroller",
  storageBucket: "arxiv-scroller.firebasestorage.app",
  messagingSenderId: "439198707331",
  appId: "1:439198707331:web:47cf07fbe25bfcca7275b6"
});

const db = getFirestore(app);

const selection = document.getElementById('selection');
const card = document.getElementById('card');
const cardContent = document.getElementById('card-content-wrapper');
const backButton = document.getElementById('back-button');

let col, num = 1, paper, slide = 0;

async function load() {
  const snap = await getDoc(doc(db, col, String(num)));
  if (!snap.exists()) { 
    num = 1; 
    return load(); 
  }
  paper = snap.data();
  slide = 0;
  cardContent.innerHTML = paper.slides[slide];
}

function nextSlide() {
  if (!paper) return;
  slide = (slide + 1) % paper.slides.length;
  cardContent.innerHTML = paper.slides[slide];
}

function prevSlide() {
  if (!paper) return;
  slide = (slide - 1 + paper.slides.length) % paper.slides.length;
  cardContent.innerHTML = paper.slides[slide];
}

function nextPaper() {
  num++;
  load();
}

function prevPaper() {
  num = (num > 1) ? num - 1 : 1;
  load();
}

function goBack() {
  card.style.display = 'none';
  selection.style.display = 'flex';
  num = 1;
  slide = 0;
  paper = null;
}

selection.onclick = e => {
  if (e.target.dataset.col) {
    col = e.target.dataset.col;
    num = 1;
    slide = 0;
    cardContent.innerHTML = '';
    selection.style.display = 'none';
    card.style.display = 'flex';
    load();
  }
};

backButton.onclick = e => {
  e.stopPropagation();
  goBack();
};

card.onclick = e => {
    if (e.target.closest('a') || e.target.id === 'back-button') {
        return;
    }

    const cardRect = card.getBoundingClientRect();
    const clickX = e.clientX - cardRect.left;
    const clickY = e.clientY - cardRect.top;
    const cardWidth = cardRect.width;
    const cardHeight = cardRect.height;

    if (clickY < cardHeight * 0.20) {
        prevPaper();
        return; 
    } 
    if (clickY > cardHeight * 0.80) {
        nextPaper();
        return; 
    }
    if (clickX > cardWidth * 0.67){
        nextSlide();
    }
    if (clickX < cardWidth * 0.33){
        prevSlide();
    }
};

</script>
</body>
</html>